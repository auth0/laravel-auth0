version: 2.1

commands:
  setup:
    steps:
      - run:
          name: Configure environment
          command: |
            apk update

      - checkout

      - run:
          name: Install dependencies
          command: |
            EXPECTED_CHECKSUM="$(php -r 'copy("https://composer.github.io/installer.sig", "php://stdout");')"
            php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"

            if [ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]; then
                >&2 echo 'ERROR: Invalid installer checksum'
                rm composer-setup.php
                exit 1
            fi

            php composer-setup.php --quiet
            RESULT=$?
            rm composer-setup.php

            php composer.phar install --no-interaction --prefer-dist

jobs:
  snyk:
    parameters:
      php:
        type: string
    docker:
      - image: php:<< parameters.php >>-cli-alpine
    steps:
      - setup
      - run:
          name: Run vulnerabilities tests (Snyk)
          command: |
            apk add npm
            npm install -g snyk
            snyk test --dev --org=auth0-sdks --project-name=auth0-PHP

  semgrep:
    docker:
      - image: returntocorp/semgrep-agent:v1
    environment:
      SEMGREP_REPO_NAME: "auth0/laravel-auth0"
      SEMGREP_REPO_URL: "https://github.com/auth0/laravel-auth0"
    steps:
      - checkout
      - run:
          name: Run vulnerabilities tests (Semgrep)
          command: |
            semgrep-agent --baseline-ref main --publish-token $SEMGREP_TOKEN

workflows:
  test:
    jobs:
      - semgrep:
          context:
            - semgrep-env
      - snyk:
          matrix:
            parameters:
              php: ["7.4", "8.0", "8.1"]
          context:
            - snyk-env
